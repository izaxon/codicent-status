<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Codicent System Status</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --color-operational: #1a9e5c;
      --color-degraded: #f5a623;
      --color-partial: #e07b39;
      --color-major: #d93025;
      --color-unknown: #9aa0a6;
      --bg: #f8f9fa;
      --surface: #ffffff;
      --text: #202124;
      --text-muted: #5f6368;
      --border: #dadce0;
      --radius: 8px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    header svg { flex-shrink: 0; }

    header h1 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }

    main {
      max-width: 800px;
      margin: 32px auto;
      padding: 0 16px;
    }

    .status-banner {
      border-radius: var(--radius);
      padding: 24px 28px;
      color: #fff;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .status-banner.operational  { background: var(--color-operational); }
    .status-banner.degraded     { background: var(--color-degraded); }
    .status-banner.partial      { background: var(--color-partial); }
    .status-banner.major        { background: var(--color-major); }
    .status-banner.unknown      { background: var(--color-unknown); }

    .status-icon {
      width: 48px;
      height: 48px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      font-size: 24px;
    }

    .status-info h2 {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .status-info p {
      font-size: 14px;
      opacity: 0.9;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px 24px;
      margin-bottom: 24px;
    }

    .card h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text);
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .meta-item {
      font-size: 13px;
      color: var(--text-muted);
    }

    .meta-item strong { color: var(--text); }

    .refresh-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s;
    }

    .refresh-btn:hover { background: var(--bg); }

    .history-list { list-style: none; }

    .history-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .history-item:last-child { border-bottom: none; }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .status-badge::before {
      content: '';
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.8;
    }

    .badge-operational { background: #e6f4ea; color: var(--color-operational); }
    .badge-degraded    { background: #fef7e0; color: #c97a00; }
    .badge-partial     { background: #fce8e0; color: var(--color-partial); }
    .badge-major       { background: #fce8e6; color: var(--color-major); }
    .badge-unknown     { background: #f1f3f4; color: var(--color-unknown); }

    .history-details { flex: 1; min-width: 0; }

    .history-message {
      font-size: 14px;
      color: var(--text);
      margin-bottom: 2px;
    }

    .history-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    .empty-history {
      font-size: 14px;
      color: var(--text-muted);
      text-align: center;
      padding: 24px 0;
    }

    footer {
      text-align: center;
      padding: 24px 16px;
      font-size: 12px;
      color: var(--text-muted);
    }

    footer a { color: var(--text-muted); }

    #countdown {
      font-size: 12px;
      color: var(--text-muted);
    }

    @media (max-width: 500px) {
      .status-banner { flex-direction: column; text-align: center; }
    }
  </style>
</head>
<body>

<header>
  <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect width="32" height="32" rx="8" fill="#0066cc"/>
    <circle cx="16" cy="16" r="8" stroke="white" stroke-width="2.5" fill="none"/>
    <circle cx="16" cy="16" r="3" fill="white"/>
  </svg>
  <h1>Codicent System Status</h1>
</header>

<main>
  <div id="status-banner" class="status-banner unknown">
    <div class="status-icon" id="status-icon">⋯</div>
    <div class="status-info">
      <h2 id="status-text">Loading…</h2>
      <p id="status-detail">Fetching current status</p>
    </div>
  </div>

  <div class="card">
    <div class="meta-row">
      <div class="meta-item">Last checked: <strong id="last-checked">—</strong></div>
      <div style="display:flex;align-items:center;gap:12px;">
        <span id="countdown"></span>
        <button class="refresh-btn" onclick="loadStatus()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
          </svg>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Incident History</h3>
    <ul class="history-list" id="history-list">
      <li class="empty-history">Loading history…</li>
    </ul>
  </div>
</main>

<footer>
  Powered by <a href="https://codicent.com" target="_blank">Codicent</a> &mdash;
  Updated automatically every 5 minutes via GitHub Actions
</footer>

<script>
  const STATUS_MAP = {
    'Operational':         { cls: 'operational',  badge: 'badge-operational', icon: '✓', label: 'All Systems Operational' },
    'Degraded Performance':{ cls: 'degraded',      badge: 'badge-degraded',    icon: '⚠', label: 'Degraded Performance' },
    'Partial Outage':      { cls: 'partial',       badge: 'badge-partial',     icon: '!', label: 'Partial Outage' },
    'Major Outage':        { cls: 'major',         badge: 'badge-major',       icon: '✕', label: 'Major Outage' },
  };

  function getStatusInfo(status) {
    return STATUS_MAP[status] || { cls: 'unknown', badge: 'badge-unknown', icon: '?', label: status || 'Unknown' };
  }

  function formatDate(iso) {
    if (!iso) return '—';
    try {
      const d = new Date(iso);
      return d.toLocaleString(undefined, {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit', timeZoneName: 'short'
      });
    } catch { return iso; }
  }

  function renderStatus(data) {
    const info = getStatusInfo(data.status);

    // Banner
    const banner = document.getElementById('status-banner');
    banner.className = 'status-banner ' + info.cls;
    document.getElementById('status-icon').textContent = info.icon;
    document.getElementById('status-text').textContent = info.label;

    const latest = data.history && data.history[0];
    document.getElementById('status-detail').textContent =
      latest ? latest.message : 'Status updated automatically';

    // Last checked
    document.getElementById('last-checked').textContent = formatDate(data.last_checked);

    // History
    const list = document.getElementById('history-list');
    if (!data.history || data.history.length === 0) {
      list.innerHTML = '<li class="empty-history">No history available yet.</li>';
      return;
    }

    list.innerHTML = data.history.map(entry => {
      const ei = getStatusInfo(entry.status);
      return `<li class="history-item">
        <span class="status-badge ${ei.badge}">${entry.status}</span>
        <div class="history-details">
          <div class="history-message">${escapeHtml(entry.message || '')}</div>
          <div class="history-time">${formatDate(entry.timestamp)}</div>
        </div>
      </li>`;
    }).join('');
  }

  function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  async function loadStatus() {
    try {
      const r = await fetch('./status.json?t=' + Date.now());
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const data = await r.json();
      renderStatus(data);
    } catch (e) {
      document.getElementById('status-text').textContent = 'Unable to load status';
      document.getElementById('status-detail').textContent = e.message;
    }
  }

  // Auto-refresh every 60 seconds with countdown
  let countdown = 60;
  function tick() {
    countdown--;
    if (countdown <= 0) {
      countdown = 60;
      loadStatus();
    }
    document.getElementById('countdown').textContent = 'Auto-refresh in ' + countdown + 's';
  }

  loadStatus();
  setInterval(tick, 1000);
</script>

</body>
</html>

name: Update System Status

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-status:
    runs-on: ubuntu-latest

    steps:
      - name: Check health endpoint
        id: health
        env:
          HEALTH_URL: ${{ vars.CODICENT_HEALTH_URL }}
        run: |
          HEALTH_URL="${HEALTH_URL:-https://codicent.com/health}"
          HTTP_CODE=$(curl -s -o /tmp/health_response.json -w "%{http_code}" \
            --max-time 15 --connect-timeout 10 "$HEALTH_URL" 2>/dev/null || echo "000")
          echo "http_code=$HTTP_CODE" >> "$GITHUB_OUTPUT"
          if [ "$HTTP_CODE" = "200" ]; then
            HEALTH_STATUS=$(python3 -c "
          import sys, json
          try:
              d = json.load(open('/tmp/health_response.json'))
              print(d.get('status', 'Unknown'))
          except Exception:
              print('Unknown')
          ")
            echo "health_status=$HEALTH_STATUS" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine system status
        id: status
        run: |
          HTTP_CODE="${{ steps.health.outputs.http_code }}"
          HEALTH_STATUS="${{ steps.health.outputs.health_status }}"
          if [ "$HTTP_CODE" = "200" ] && [ "$HEALTH_STATUS" = "Healthy" ]; then
            echo "system_status=Operational" >> "$GITHUB_OUTPUT"
            echo "message=All systems operational" >> "$GITHUB_OUTPUT"
          elif [ "$HTTP_CODE" = "200" ]; then
            echo "system_status=Degraded Performance" >> "$GITHUB_OUTPUT"
            echo "message=Service responded but reported an unexpected status" >> "$GITHUB_OUTPUT"
          elif [ "$HTTP_CODE" = "000" ]; then
            echo "system_status=Major Outage" >> "$GITHUB_OUTPUT"
            echo "message=System is unreachable (connection timed out)" >> "$GITHUB_OUTPUT"
          elif echo "$HTTP_CODE" | grep -qE '^5'; then
            echo "system_status=Partial Outage" >> "$GITHUB_OUTPUT"
            echo "message=Service returned an error (HTTP $HTTP_CODE)" >> "$GITHUB_OUTPUT"
          else
            echo "system_status=Degraded Performance" >> "$GITHUB_OUTPUT"
            echo "message=Unexpected response from service (HTTP $HTTP_CODE)" >> "$GITHUB_OUTPUT"
          fi

      - name: Update status.json
        env:
          GH_TOKEN: ${{ github.token }}
          SYSTEM_STATUS: ${{ steps.status.outputs.system_status }}
          STATUS_MESSAGE: ${{ steps.status.outputs.message }}
        run: |
          python3 - <<'PYEOF'
          import json, os, base64, urllib.request
          from datetime import datetime, timezone

          token = os.environ['GH_TOKEN']
          repo  = 'izaxon/codicent-status'
          path  = 'status.json'
          api   = f'https://api.github.com/repos/{repo}/contents/{path}'
          hdrs  = {
              'Authorization': f'Bearer {token}',
              'Accept': 'application/vnd.github+json',
              'X-GitHub-Api-Version': '2022-11-28',
              'User-Agent': 'codicent-status-workflow',
          }

          req = urllib.request.Request(api, headers=hdrs)
          with urllib.request.urlopen(req) as r:
              file_info = json.load(r)
          sha  = file_info['sha']
          data = json.loads(base64.b64decode(file_info['content']))

          new_status  = os.environ['SYSTEM_STATUS']
          new_message = os.environ['STATUS_MESSAGE']

          if data.get('status') == new_status:
              print('No status change - skipping update')
              raise SystemExit(0)

          timestamp = datetime.now(timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ')
          data['status']       = new_status
          data['last_checked'] = timestamp
          data.setdefault('history', []).insert(0, {
              'status':    new_status,
              'timestamp': timestamp,
              'message':   new_message,
          })
          data['history'] = data['history'][:50]

          payload = json.dumps({
              'message': f"chore: update system status to '{new_status}' [skip ci]",
              'content': base64.b64encode((json.dumps(data, indent=2) + '\n').encode()).decode(),
              'sha':     sha,
          }).encode()

          req = urllib.request.Request(api, data=payload, headers={**hdrs, 'Content-Type': 'application/json'}, method='PUT')
          with urllib.request.urlopen(req) as r:
              result = json.load(r)
          print(f"Updated: {result['commit']['html_url']}")
          PYEOF